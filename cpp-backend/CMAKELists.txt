cmake_minimum_required(VERSION 3.15)
project(TermiWeb_Backend VERSION 1.0.0 LANGUAGES CXX)

# Set C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Export compile commands for clangd
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Output directories
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# Find RocksDB
find_package(RocksDB)
if(NOT RocksDB_FOUND)
    # Alternative: look for it manually
    find_path(ROCKSDB_INCLUDE_DIR rocksdb/db.h
        PATHS
        ${CMAKE_SOURCE_DIR}/rocksdb/include
        /opt/homebrew/include
        /usr/local/include
        /usr/include)
    find_library(ROCKSDB_LIBRARY
        NAMES rocksdb librocksdb.dylib librocksdb.so
        PATHS
        ${CMAKE_SOURCE_DIR}/rocksdb
        /opt/homebrew/lib
        /usr/local/lib
        /usr/lib)

    if(ROCKSDB_INCLUDE_DIR AND ROCKSDB_LIBRARY)
        set(RocksDB_FOUND TRUE)
        add_library(RocksDB::rocksdb UNKNOWN IMPORTED)
        set_target_properties(RocksDB::rocksdb PROPERTIES
            IMPORTED_LOCATION ${ROCKSDB_LIBRARY}
            INTERFACE_INCLUDE_DIRECTORIES ${ROCKSDB_INCLUDE_DIR})
        message(STATUS "Found RocksDB: ${ROCKSDB_LIBRARY}")
    else()
        message(FATAL_ERROR "RocksDB not found. Please install RocksDB or build it in ./rocksdb")
    endif()
endif()

# Find Boost (for URL parsing)
find_package(Boost 1.70 REQUIRED COMPONENTS url)

# Include directories
include_directories(
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_SOURCE_DIR}/src/crawler
    ${CMAKE_SOURCE_DIR}/src/crawler/Database
    ${CMAKE_SOURCE_DIR}/src/crawler/utils
)

# Database library
add_library(crawler_database
    src/crawler/Database/database.cpp
    src/crawler/Database/database.hpp
)

target_link_libraries(crawler_database
    PUBLIC RocksDB::rocksdb
)

# URL utilities library
add_library(url_utils INTERFACE)
target_sources(url_utils INTERFACE
    ${CMAKE_SOURCE_DIR}/src/crawler/utils/normalize_url.hpp
)

target_link_libraries(url_utils
    INTERFACE Boost::url
)

# Crawler library
add_library(crawler
    src/crawler/crawler.hpp
)

set_target_properties(crawler PROPERTIES LINKER_LANGUAGE CXX)

target_link_libraries(crawler
    PUBLIC crawler_database
    PUBLIC url_utils
)

# Main executable (if you have a main.cpp)
# add_executable(termi_web_backend src/main.cpp)
# target_link_libraries(termi_web_backend
#     PRIVATE crawler
#     PRIVATE crawler_database
#     PRIVATE url_utils
# )

# Enable warnings
if(MSVC)
    target_compile_options(crawler_database PRIVATE /W4)
else()
    target_compile_options(crawler_database PRIVATE -Wall -Wextra -pedantic)
endif()

# Installation rules (optional)
install(TARGETS crawler_database crawler
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
)

install(DIRECTORY src/crawler/
    DESTINATION include/termi_web
    FILES_MATCHING PATTERN "*.hpp"
)

include(FetchContent)

FetchContent_Declare(
    gumbo-parser
    GIT_REPOSITORY https://github.com/google/gumbo-parser.git
    GIT_TAG        master
)
FetchContent_MakeAvailable(gumbo-parser)

FetchContent_Declare(cpr GIT_REPOSITORY https://github.com/libcpr/cpr.git
                         GIT_TAG da40186618909b1a7363d4e4495aa899c6e0eb75.12.0) # Replace with your desired git commit from: https://github.com/libcpr/cpr/releases
FetchContent_MakeAvailable(cpr)

add_library(parser
    src/crawler/utils/page_parser.hpp
)

target_link_libraries(parser PRIVATE cpr::cpr)